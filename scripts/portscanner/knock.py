import multiprocessing
import subprocess
import argparse
import re

from banner import banner

class Scanner:
    def __init__(self, options):
        self.parser = argparse.ArgumentParser(description="A simple argparse example")
        self.options = {}
        self.open_ports = {}

    def arguments_parser(self):
        self.parser.add_argument("-v", "--verbose", help="increase output verbosity", action='store_true')
        self.parser.add_argument("-a", "--address", required=True, help="IP address to scan -> example: -a 192.168.1.1")
        self.parser.add_argument("-p", "--port", type=int, default=80, help="Port to scan -> example: -p 80")
        self.parser.add_argument("-p-", "--allports", help="Scan all ports -> example: -p-", action='store_true')
        args = self.parser.parse_args()
        return vars(args)
 
    def use_arguments(self, options, x):
        if options['allports']:
            for port in range((13107*x-13107), (13107*x)):
                result = subprocess.run(["nc", "-vz", f"{options['address']}", f"{port}"], 
                               stdout=subprocess.PIPE, stderr=subprocess.STDOUT,  text=True) 
                output = result.stdout
                if "open" in output:
                    pattern = r'\(.*?\)'
                    service = re.findall(pattern, output)
                    service = re.sub(r'[!"#]', '', service[0])
                    self.open_ports[service] = port

                    if options['verbose']:
                        print(f"SERVICE: {self.open_ports[service]} : PORT {port} OPEN")

        elif options['port']:
                result = subprocess.run(["nc", "-vz", f"{options['address']}", f"{options['port']}"], 
                               stdout=subprocess.PIPE, stderr=subprocess.STDOUT,  text=True) 
                output = result.stdout
                if "open" in output:
                    pattern = r'\(.*?\)'
                    service = re.findall(pattern, output)
                    service = re.sub(r'[!"#]', '', service[0])
                    self.open_ports[service] = self.options['port']

                    if options['verbose']:
                        print(f"SERVICE: {self.open_ports[service]} : PORT {options['port']} OPEN")
        return 0 

    def output_results(self):
        for x, y in self.open_ports.items():
            print(f"SERVICE: {x} : PORT {y} OPEN")
        return 0


def scanner_worker(options, x):
    scanner = Scanner(options)
    scanner.use_arguments(options, x)
    return scanner.open_ports


def main():
    print(banner())
    scanner = Scanner(None)
    options = scanner.arguments_parser()
    
    with multiprocessing.Pool(5) as pool:
        results = pool.starmap(scanner_worker, [(options, x) for x in range(1, 6)])

    all_open_ports = {}
    for open_ports in results:
        all_open_ports.update(open_ports) 
    
    final_output = """
    ############# PORTSCAN RESULT #############

    """
    for service, port in all_open_ports.items():
        final_output += f"""
    SERVICE: {service} : PORT {port} OPEN\n"""

    print(final_output)
    print("""
    ##########################################""")
        
if __name__ == '__main__':
    main()

