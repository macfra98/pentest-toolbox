#!/bin/sh

echo "[+] PREPARING ENVIRONMENT"
echo """

WELCOME TO PENTEST-TOOLBOX!
INSTALLATION OF TOOLS...

"""

cd ~/pentest-toolbox || exit
python3 -m venv toolbox

. toolbox/bin/activate

# Define the options
options="autopfuscate binsploit repgen passcrack filemagic Done"

# Function to display the menu
show_menu() {
    echo "Select options (enter the number). Select 'Done' to finish:"
    i=1
    for opt in $options; do
        printf "%s) %s\n" "$i" "$opt"
        for sel in $selected; do
            if [ "$sel" = "$opt" ]; then
                echo "   -> Selected"
            fi
        done
        i=$((i + 1))
    done
}

# Initialize selected options string
selected=""

# Main loop
while true; do
    # Show the menu
    show_menu

    # Read user choice
    printf "Enter choice: "
    read -r choice

    # Validate input
    case $choice in
        ''|*[!0-9]*)
            echo "Invalid option: $choice"
            continue;;
    esac

    # Map choice number to option name
    optname=$(printf "%s\n" $options | sed -n "${choice}p")
    if [ -z "$optname" ]; then
        echo "Invalid option: $choice"
        continue
    fi

    # Handle the selection
    if [ "$optname" = "Done" ]; then
        break
    else
        if printf "%s\n" $selected | grep -qx "$optname"; then
            # Deselect the option
            new_selected=""
            for sel in $selected; do
                if [ "$sel" != "$optname" ]; then
                    new_selected="$new_selected $sel"
                fi
            done
            selected="$new_selected"
        else
            # Select the option
            selected="$selected $optname"
        fi
    fi
done

# Display selected options
echo "You selected:"
for sel in $selected; do
    printf "   %s\n" "$sel"
done

pip install wheel
requirements_list=""

for element in $selected; do
    if [ "$element" = "binsploit" ]; then
        if grep -q "pyyaml" "requirements.txt"; then
            echo "pyyaml already exists, skipping."
        else
            requirements_list="$requirements_list pyyaml"
        fi
    elif [ "$element" = "repgen" ]; then
        if ! grep -q "openai" "requirements.txt"; then
            requirements_list="$requirements_list openai"
        fi
        if ! grep -q "python-docx" "requirements.txt"; then
            requirements_list="$requirements_list python-docx"
        fi
    
    elif [ "$element" = "filemagic" ]; then
            requirements_list="$requirements_list python-docx"
            requirements_list="$requirements_list PyPDF2"
            requirements_list="$requirements_list xlsxwriter"
            requirements_list="$requirements_list python-docx"
            requirements_list="$requirements_list Pillow"
    fi
done

for element in $requirements_list; do
    echo "$element" >> requirements.txt
done

echo "[+] Installing the necessary packages\n"

pip install .
deactivate

echo "[+] Installation finished!"
echo "[!] USE: '. toolbox/bin/activate' to begin using the tools"

